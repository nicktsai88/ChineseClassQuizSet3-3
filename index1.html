<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹æ–‡æ”¹éŒ¯æ¸¬é©— (ç¬¬3å†Š)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            /* é…è‰²ç³»çµ± */
            --primary-color: #00695c;   /* æ”¹ç”¨æ·±ç¶ è‰²ç³»ä½œç‚ºæ”¹éŒ¯é¡Œçš„ä¸»é¡Œè‰² */
            --secondary-color: #4db6ac; 
            --bg-color: #e0f2f1;        
            --text-color: #004d40;      
            --accent-color: #009688;    
            --correct-color: #2e7d32;   
            --wrong-color: #c62828;     
            --favorite-color: #ff8f00;  
            --player-bg: #ffffff;
            --header-height: 100px;
        }

        /* é–å®š Body æ²å‹• */
        html, body {
            height: 100%;
            overflow: hidden; 
        }

        body { 
            font-family: 'Noto Sans TC', "Microsoft JhengHei", Arial, sans-serif; 
            max-width: 98vw; 
            margin: 0 auto; 
            padding: calc(var(--header-height) + 20px) 20px 20px 20px; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            background-image: 
                linear-gradient(30deg, #b2dfdb 12%, transparent 12.5%, transparent 87%, #b2dfdb 87.5%, #b2dfdb),
                linear-gradient(150deg, #b2dfdb 12%, transparent 12.5%, transparent 87%, #b2dfdb 87.5%, #b2dfdb),
                linear-gradient(30deg, #b2dfdb 12%, transparent 12.5%, transparent 87%, #b2dfdb 87.5%, #b2dfdb),
                linear-gradient(150deg, #b2dfdb 12%, transparent 12.5%, transparent 87%, #b2dfdb 87.5%, #b2dfdb),
                linear-gradient(60deg, #b2dfdb77 25%, transparent 25.5%, transparent 75%, #b2dfdb77 75%, #b2dfdb77),
                linear-gradient(60deg, #b2dfdb77 25%, transparent 25.5%, transparent 75%, #b2dfdb77 75%, #b2dfdb77);
            background-size: 80px 140px;
            background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;
            background-attachment: fixed;
            box-sizing: border-box; 
        }

        h1, h2, h3 { text-align: center; color: var(--text-color); }
        h1 { color: var(--primary-color); text-shadow: 1px 1px 2px rgba(255,255,255,0.5); margin-top: 0;}

        /* --- éŸ³æ¨‚æ’­æ”¾å™¨å›ºå®šåˆ— --- */
        #music-player-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background-color: var(--player-bg); border-bottom: 3px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center;
            justify-content: space-between; padding: 0 15px; box-sizing: border-box;
            z-index: 10000;
        }
        .player-left { flex: 1; display: flex; justify-content: flex-start; align-items: center; }
        .player-right { flex: 1; display: flex; justify-content: flex-end; }
        .player-icon { font-size: 1.5em; background: #e0f2f1; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid var(--primary-color); color: var(--primary-color);}

        #yt-wrapper {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 144px; height: 81px; background: #000; border: 2px solid var(--text-color);
            border-radius: 4px; overflow: hidden; transition: all 0.3s ease; z-index: 5;
        }
        .yt-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 20; }
        #yt-wrapper.video-hidden { width: 0; height: 0; border: none; opacity: 0; }
        
        .player-controls { display: flex; align-items: center; gap: 8px; }
        .ctrl-btn { background: none; border: none; cursor: pointer; color: #7f8c8d; font-size: 1.4em; padding: 5px; }
        .ctrl-btn:hover, .ctrl-btn.active { color: var(--primary-color); }
        .volume-container { display: flex; align-items: center; gap: 5px; }
        .volume-slider { width: 60px; accent-color: var(--primary-color); cursor: pointer;}
        .mode-btn { border: 1px solid #bdc3c7; background: #fff; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        .mode-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }

        /* --- å®¹å™¨é€šç”¨ --- */
        .container-box {
            background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(10px); position: relative; margin-bottom: 20px;
            max-height: calc(100vh - 180px); 
            overflow-y: auto; 
        }

        /* --- Welcome Screen --- */
        #welcome-screen {
            background: linear-gradient(rgba(255,255,255,0.8), rgba(255,255,255,0.8)), url('https://www.transparenttextures.com/patterns/cubes.png');
            border-left: 6px solid var(--primary-color);
        }
        .avatar-selection { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .avatar-option {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff; cursor: pointer;
            transition: 0.3s; object-fit: cover; background: #FFF; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .avatar-option.selected { border-color: var(--primary-color); transform: scale(1.1); }
        .quick-login-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
        .user-tag { background: #fff; border: 1px solid #bdc3c7; padding: 6px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.95em;}
        .delete-user { font-weight: bold; padding: 2px 6px; border-radius: 50%; background: #eee; color: #888; }
        .delete-user:hover { background: var(--wrong-color); color: #fff; }
        input[type="text"] { padding: 12px; font-size: 1.2em; border: 2px solid #bdc3c7; border-radius: 30px; width: 80%; text-align: center; margin: 10px 0;}

        /* --- Dashboard (Level Screen) --- */
        #level-screen-content {
            display: flex; gap: 20px; align-items: flex-start;
            min-height: 400px;
            justify-content: center;
        }
        
        #level-screen {
            background: linear-gradient(rgba(255,255,255,0.8), rgba(255,255,255,0.8));
        }

        .dashboard-std-zone {
            flex: 1; border: 1px solid #b2dfdb; border-radius: 12px; padding: 20px;
            background: rgba(255,255,255,0.9); max-width: 900px;
        }
        .dashboard-title { 
            font-size: 1.6em; 
            color: var(--primary-color); margin-bottom: 20px; 
            display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #b2dfdb; padding-bottom: 10px;
            justify-content: space-between;
            font-weight: bold;
        }

        .overall-progress { font-size: 1em; color: #555; background: #fff; padding: 8px 18px; border-radius: 20px; border: 1px solid #ddd; }

        .level-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 25px; justify-items: center; 
            padding-bottom: 120px; 
        }
        .level-grid-btn {
            width: 100%; aspect-ratio: 1; min-height: 140px; 
            border-radius: 18px;
            background: #fff; border: 4px solid var(--primary-color); 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.2s; box-shadow: 0 6px 0 #80cbc4; color: var(--text-color);
            padding: 15px;
        }
        .level-grid-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 0 #80cbc4; background: #e0f2f1; }
        .level-grid-btn:active:not(:disabled) { transform: translateY(2px); box-shadow: none; }
        .level-grid-btn:disabled { border-color: #bdc3c7; color: #bdc3c7; background: #f0f0f0; cursor: not-allowed; box-shadow: none;}
        
        .lvl-icon { 
            font-size: 3.5em; 
            margin-bottom: 10px; 
            font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", "Android Emoji", sans-serif;
            line-height: 1.1;
        }
        
        .lvl-score { font-size: 1.1em; font-weight: bold; color: var(--correct-color); background: #e8f5e9; padding: 4px 10px; border-radius: 12px; margin-top: 8px; }
        .lvl-label { font-size: 1.4em; font-weight: bold; font-family: "KaiTi", "BiauKai", serif;}
        
        .resume-text { 
            font-size: 1em !important; 
            color: #e67e22; 
            font-weight: bold; 
            margin-top: 5px; 
            background: #fff3e0; 
            padding: 2px 8px; 
            border-radius: 10px; 
        }

        /* --- Button Styles --- */
        .btn { padding: 12px 28px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; font-size: 1.2em; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #fff; background: var(--primary-color); display: inline-flex; align-items: center; gap: 5px;}
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,0.15); }
        .btn-red { background: var(--wrong-color); } .btn-red:hover { background: #b71c1c; }
        .btn-green { background: var(--correct-color); } .btn-green:hover { background: #1b5e20; }
        .btn-pink { background: var(--favorite-color); } .btn-pink:hover { background: #ef6c00; }
        .btn-gray { background: #95a5a6; } .btn-gray:hover { background: #7f8c8d; }
        .btn-sm { padding: 8px 18px; font-size: 1em; box-shadow: none; border: 1px solid rgba(255,255,255,0.3); }
        .btn-sm:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- Error Hunt Mode Styles --- */
        .quiz-header { display: none; } 
        
        .question-box { 
            background: #fff; 
            padding: 0;
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            display: flex;
            flex-wrap: wrap; /* RWD */
            overflow: hidden;
            border-top: 5px solid var(--primary-color);
            height: calc(100vh - 240px); 
            align-items: stretch;
        }

        /* å·¦å´ï¼šæ”¹éŒ¯å¥å­å€ */
        .article-section {
            flex: 2; /* ä½”æ¯”è¼ƒå¤§ */
            min-width: 300px;
            padding: 40px;
            background: #fafafa;
            border-right: 1px solid #eee;
            height: 100%;
            overflow-y: auto;
            scrollbar-width: thin;
            padding-bottom: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center; /* å‚ç›´ç½®ä¸­ */
        }

        /* å³å´ï¼šé¸é …å€ */
        .questions-section {
            flex: 1; /* ä½”æ¯”è¼ƒå° */
            min-width: 250px;
            padding: 30px;
            background: #e0f2f1;
            height: 100%;
            overflow-y: auto;
            scrollbar-width: thin;
            padding-bottom: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* å¥å­æ¨£å¼ */
        .sentence-display {
            font-size: 2.2em; /* å­—é«”åŠ å¤§ */
            line-height: 2;
            color: #333;
            letter-spacing: 0.1em;
            text-align: justify;
        }

        /* å¯äº’å‹•çš„æ–‡å­— */
        .interactive-char {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
            display: inline-block;
        }
        .interactive-char:hover {
            background-color: #e0e0e0;
            transform: scale(1.1);
        }
        
        /* å·²ä¿®æ­£çš„æ­£ç¢ºå­— */
        .interactive-char.fixed {
            color: var(--wrong-color); /* æ”¹éŒ¯å¾Œçš„å­—é¡¯ç¤ºç´…è‰²ï¼Œä¾ç…§æ…£ä¾‹ */
            font-weight: bold;
            pointer-events: none; /* ä¸å¯å†é» */
            animation: popIn 0.3s ease;
        }
        
        /* é»é¸ä¸­çš„å­— */
        .interactive-char.active {
            background-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* å³å´é¸é …æç¤º */
        .options-placeholder {
            text-align: center;
            color: #777;
            font-size: 1.2em;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            animation: fadeIn 0.3s;
        }

        .option-btn { 
            width: 100%; 
            padding: 20px; 
            background: #fff; 
            border: 3px solid #b2dfdb; 
            border-radius: 15px; 
            cursor: pointer; 
            font-size: 1.8em; 
            text-align: center; 
            transition: 0.2s; 
            color: #004d40;
            font-weight: bold;
        }
        .option-btn:hover:not(:disabled) { border-color: var(--primary-color); background: #b2dfdb; }
        .option-btn.correct { background: #c8e6c9; border-color: var(--correct-color); color: #1b5e20; }
        .option-btn.wrong { background: #ffcdd2; border-color: var(--wrong-color); color: #b71c1c; }

        .article-title-bar {
            display: flex; justify-content: flex-end; align-items: center; gap: 10px;
            margin-bottom: 20px; 
            font-size: 0.9em;
            color: #666;
        }
        
        .fav-heart {
            font-size: 2em; cursor: pointer; color: #ccc; transition: 0.3s;
        }
        .fav-heart.active { color: var(--favorite-color); }
        .fav-heart:hover { transform: scale(1.1); }
        .fav-heart:active { transform: scale(0.9); }

        /* --- Collection & Mistake & History --- */
        .list-screen-content { padding: 10px; }
        .list-item-card {
            background: #fff; border-radius: 10px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: 0.2s;
        }
        .list-item-card:hover { transform: translateX(5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .list-item-card.fav-item { border-left-color: var(--favorite-color); }
        .list-item-card.mistake-item { border-left-color: var(--wrong-color); }
        
        .list-item-title { font-size: 1.3em; font-weight: bold; color: #333; }
        .list-item-info { color: #666; font-size: 1em; margin-top: 5px; }
        .list-empty-msg { text-align: center; color: #888; font-size: 1.3em; margin-top: 30px; }

        /* --- Modal & AI Chat (Same as before but styles adjusted) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; position: relative; text-align: center; }
        .modal-close { position: absolute; top: -15px; right: -15px; background: red; color: white; width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; cursor: pointer; font-weight: bold;}

        #ai-chat-window {
            position: fixed; bottom: 20px; right: 20px; width: 350px; height: 500px;
            background: #fff; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 2px solid var(--primary-color); z-index: 20001; display: none; flex-direction: column; overflow: hidden; font-size: 0.95em;
        }
        .ai-header {
            background: var(--primary-color); color: white; padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center; font-weight: bold;
        }
        .ai-header-close { cursor: pointer; font-size: 1.2em; background: rgba(255,255,255,0.2); border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;}
        .ai-header-close:hover { background: rgba(255,255,255,0.4); }
        .ai-messages {
            flex: 1; padding: 15px; overflow-y: auto; background: var(--bg-color);
            display: flex; flex-direction: column; gap: 10px;
        }
        .ai-msg { padding: 8px 12px; border-radius: 10px; max-width: 85%; line-height: 1.4; word-wrap: break-word; }
        .ai-msg.user { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 2px; }
        .ai-msg.bot { align-self: flex-start; background: white; border: 1px solid #ddd; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ai-input-area {
            padding: 10px; background: white; border-top: 1px solid #eee; display: flex; gap: 8px;
        }
        .ai-input { flex: 1; padding: 8px 12px; border: 1px solid #ccc; border-radius: 20px; outline: none; transition: 0.3s; }
        .ai-input:focus { border-color: var(--primary-color); }
        .ai-send-btn { background: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .ai-send-btn:hover { background: #004d40; }

        /* Floating Next Button */
        #next-btn {
            display: none;
            position: fixed;
            bottom: 70px;
            right: 40px; 
            width: auto;
            padding: 15px 30px;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 1.4em;
            margin-top: 0;
            animation: bounceIn 0.5s;
        }
        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 20002;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 1.2em;
        }
        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* RWD */
        @media (max-width: 768px) {
            #level-screen-content { flex-direction: column; }
            .dashboard-std-zone { border-right: none; border-bottom: 1px solid #b2dfdb; }
            #music-player-bar { height: 60px; padding: 0 10px; }
            body { padding-top: 80px; }
            #yt-wrapper { display: none; position: fixed; bottom: 10px; right: 10px; width: 120px; height: 67px; top: auto; left: auto; transform: none; }
            #yt-wrapper.mobile-visible { display: block; }
            
            #ai-chat-window { width: 90%; right: 5%; bottom: 80px; height: 50vh; }

            .question-box { 
                flex-direction: column;
                height: auto; 
            }
            .article-section { 
                border-right: none; 
                border-bottom: 1px solid #eee;
                height: auto; 
                min-height: 250px;
                overflow-y: visible; 
            }
            .questions-section {
                height: auto; 
                min-height: 250px;
                overflow-y: visible;
            }
            
            .nav-text { display: none; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- éŸ³æ¨‚æ’­æ”¾å™¨ -->
    <div id="music-player-bar">
        <div class="player-left">
            <div class="player-icon">ğŸµ</div>
            
            <div id="dashboard-nav-btns" style="display:none; align-items:center; gap:10px; margin-left:20px;">
                <button class="btn btn-sm btn-red" onclick="showMistakes()">ğŸ“• <span class="nav-text">éŒ¯é¡Œæœ¬</span></button>
                <button class="btn btn-sm btn-pink" onclick="showFavorites()">â­ <span class="nav-text">æˆ‘çš„æœ€æ„›</span></button>
                <button class="btn btn-sm btn-green" onclick="showHistory()">ğŸ† <span class="nav-text">é‡‘æ¦œ</span></button>
                <button class="btn btn-sm btn-gray" onclick="logout()">ğŸšª <span class="nav-text">ç™»å‡º</span></button>
            </div>

            <div id="quiz-nav-info" style="display:none; align-items:center; gap:15px; margin-left:15px;">
                <span id="nav-level-title" style="font-weight:bold; color:var(--primary-color); font-size: 1.3em;"></span>
                <span style="font-weight:bold; color:#555; white-space: nowrap; font-size: 1.2em;">
                    <span id="nav-current-q">1</span> / <span id="nav-total-q">10</span>
                </span>
                <button class="btn btn-gray" style="padding: 8px 18px; font-size: 1em;" onclick="exitQuiz()">ğŸ  é›¢é–‹</button>
            </div>
        </div>
        
        <div id="yt-wrapper">
            <div id="yt-player"></div>
            <div class="yt-overlay"></div>
        </div>
        
        <div class="player-right">
            <div class="player-controls">
                <button class="ctrl-btn" onclick="prevTrack()">â®</button>
                <button id="main-play-btn" class="ctrl-btn" onclick="togglePlay()">â–¶</button>
                <button class="ctrl-btn" onclick="nextTrack()">â­</button>
                
                <div class="volume-container">
                    <input type="range" id="volume-slider" class="volume-slider" min="0" max="100" value="30" oninput="setVolume(this.value)">
                </div>

                <button id="toggle-video-btn" class="ctrl-btn active" onclick="toggleVideoDisplay()">ğŸ‘ï¸</button>
                <button id="ai-btn" class="ctrl-btn" onclick="toggleChatWindow()" title="AI æ›¸åƒ®">ğŸ¤–</button>
                <button id="mode-btn" class="mode-btn" onclick="changeMode()">
                    <span id="mode-icon">ğŸ”</span>
                </button>
            </div>
        </div>
    </div>

    <!-- æ­¡è¿ç•«é¢ -->
    <div id="welcome-screen" class="container-box fade-in">
        <h1>åœ‹æ–‡æ”¹éŒ¯æ¸¬é©— (ç¬¬3å†Š)</h1>
        <div style="font-size: 4em; text-align: center; margin: 20px;">ğŸ•µï¸â€â™‚ï¸ğŸ“âœ…</div>
        <p style="text-align: center; font-size: 1.2em;">çœ¼æ˜æ‰‹å¿«ï¼Œæ‰¾å‡ºéŒ¯åˆ¥å­—ï¼è«‹è¼¸å…¥é›…è™Ÿï¼Œæº–å‚™é–‹å§‹æŒ‘æˆ°ï¼</p>
        
        <div style="text-align:center;">
            <input type="text" id="username" placeholder="è«‹è¼¸å…¥é›…è™Ÿ..." />
        </div>
        
        <div class="avatar-selection">
            <img src="images/Chris.png" class="avatar-option selected" onclick="selectAvatar('Chris.png', this)">
            <img src="images/Louis.png" class="avatar-option" onclick="selectAvatar('Louis.png', this)">
            <img src="images/kitty.png" class="avatar-option" onclick="selectAvatar('kitty.png', this)">
        </div>

        <div id="quick-login-area" class="quick-login-area"></div>

        <div style="text-align:center; margin-top: 30px;">
            <button class="btn" onclick="loginAndStart()">ğŸš€ é–‹å§‹æŒ‘æˆ°</button>
        </div>
    </div>

    <!-- å„€è¡¨æ¿ (Level Screen) -->
    <div id="level-screen" class="container-box fade-in" style="display: none;">
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="user-avatar-display" src="" style="width:50px; height:50px; border-radius:50%; vertical-align:middle; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
            <span style="font-size: 1.4em; font-weight: bold; margin-left: 10px;">æŒ‘æˆ°è€…ï¼š<span id="display-name" style="color:var(--primary-color);"></span></span>
        </div>

        <div id="level-screen-content">
            <div class="dashboard-std-zone">
                <div class="dashboard-title">
                    <span>ğŸ“š æ”¹éŒ¯æŒ‘æˆ°æ¨¡å¼</span>
                    <span id="overall-progress" class="overall-progress">ç¸½é€²åº¦ï¼š0%</span>
                </div>
                <div id="level-grid" class="level-grid"></div>
            </div>
        </div>
    </div>

    <!-- æ¸¬é©—ä»‹é¢ (Error Hunt) -->
    <div id="quiz-content" class="container-box fade-in" style="display: none;">
        <div class="quiz-header">
            <h3 id="level-title" style="margin:0; color:var(--primary-color);">é—œå¡ X</h3>
        </div>
        
        <div id="question-container">
            <div class="question-box">
                <div class="article-section">
                    <div class="article-title-bar">
                        <div style="margin-right: auto; font-weight: bold; font-size: 1.2em;">è«‹é»æ“Šå¥å­ä¸­çš„éŒ¯åˆ¥å­—ï¼š</div>
                        <div id="fav-icon" class="fav-heart" title="åŠ å…¥æœ€æ„›">â™¡</div>
                    </div>
                    <div id="sentence-display" class="sentence-display"></div>
                </div>
                <div class="questions-section">
                    <div id="options-area">
                        <div class="options-placeholder">ğŸ‘ˆ è«‹å…ˆåœ¨å·¦å´æ‰¾å‡ºéŒ¯åˆ¥å­—</div>
                    </div>
                </div>
            </div>
        </div>
        
        <button id="next-btn" class="btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡ï¸</button>
    </div>

    <!-- çµç®—ç•«é¢ -->
    <div id="score-box" class="container-box fade-in" style="display: none; text-align: center;">
        <h2 style="color: var(--primary-color); font-size: 2.2em;">ğŸ‰ é—œå¡å®Œæˆ</h2>
        <p style="font-size: 1.8em; margin: 15px;">æŒ‘æˆ°è€…ï¼š<span id="final-name"></span></p>
        <div style="font-size: 5em; font-weight: bold; color: var(--accent-color); margin: 30px 0;">
            <span id="final-score">0</span> <span style="font-size:0.4em; color:#777;">åˆ†</span>
        </div>
        <div id="score-comment" style="font-size: 1.5em; color: #e67e22; margin-bottom: 30px; font-weight: bold;"></div>
        
        <div id="unlock-msg" style="display:none; color:var(--correct-color); font-weight:bold; font-size:1.5em; margin-bottom:20px;">ğŸ”“ ä¸‹ä¸€é—œå¡é–‹å•Ÿï¼</div>

        <div style="display: flex; justify-content: center; gap: 20px;">
            <button class="btn" style="padding: 15px 40px; font-size: 1.3em;" onclick="goToDashboard()">ğŸ—ºï¸ è¿”å›åœ°åœ–</button>
        </div>
    </div>

    <!-- æˆ‘çš„æœ€æ„›ç•«é¢ -->
    <div id="favorites-screen" class="container-box fade-in" style="display: none;">
        <h2 style="color: var(--favorite-color);">â­ æˆ‘çš„æœ€æ„›</h2>
        <div id="favorites-list" class="list-screen-content"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="goToDashboard()">ğŸ—ºï¸ è¿”å›</button>
        </div>
    </div>

    <!-- éŒ¯é¡Œæœ¬ç•«é¢ -->
    <div id="mistakes-screen" class="container-box fade-in" style="display: none;">
        <h2 style="color: var(--wrong-color);">ğŸ“• éŒ¯é¡Œæ‹¾éº</h2>
        <div id="mistakes-list" class="list-screen-content"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="goToDashboard()">ğŸ—ºï¸ è¿”å›</button>
        </div>
    </div>

    <!-- å…¶ä»–ç•«é¢ (History) -->
    <div id="history-screen" class="container-box fade-in" style="display: none;">
        <h2>ğŸ† é‡‘æ¦œ</h2>
        <ul id="history-list" style="list-style: none; padding: 0;"></ul>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="goToDashboard()">ğŸ—ºï¸ è¿”å›</button>
        </div>
    </div>

    <!-- AI Chat Window -->
    <div id="ai-chat-window">
        <div class="ai-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <span>ğŸ¤– AI æ›¸åƒ®</span>
                <span class="ai-header-close" onclick="resetAiKey()" title="é‡è¨­ API Key" style="font-size: 0.9em;">ğŸ”‘</span>
            </div>
            <span class="ai-header-close" onclick="toggleChatWindow()">Ã—</span>
        </div>
        <div id="ai-messages" class="ai-messages">
            <div class="ai-msg bot">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI æ›¸åƒ®ï¼Œå°æ–¼æ”¹éŒ¯å­—æœ‰ç–‘å•éƒ½å¯ä»¥å•æˆ‘å–”ï¼</div>
        </div>
        <div class="ai-input-area">
            <input type="text" id="ai-input" class="ai-input" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="handleAiKeypress(event)">
            <button class="ai-send-btn" onclick="sendAiMessage()">ç™¼é€</button>
        </div>
    </div>
    
    <!-- Toast Message -->
    <div id="toast"></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // AI Configuration
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=";

        // è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸
        // ä¿®æ”¹é»ï¼šLevel config updated to 26 levels (1-25: 10 questions, 26: 7 questions)
        const LEVEL_CONFIG = Array(25).fill(10).concat([7]); // 26 levels total
        
        const YOUTUBE_PLAYLIST = ['iLAS0vy7-78', '5zeyr-_G_4w', 'aZXJATkkDoA', 'UKbZ4r88z3Q', 'aGZk0nEBWv4', 'advioIb8-gE'];
        // LocalStorage å‰ç¶´
        const APP_PREFIX = 'ChineseClassQuizSet3-3_';
        
        let player, isPlayerReady = false, isPlaying = false;
        let allQuestions = [], currentQuizData = [];
        let userName = "", currentAvatar = "Chris.png";
        
        // å½±ç‰‡ç´¢å¼•è¿½è¹¤ (éš¨æ©Ÿé–‹å§‹)
        let currentVideoIdx = Math.floor(Math.random() * YOUTUBE_PLAYLIST.length);
        
        // æ¸¬é©—ç‹€æ…‹
        let quizState = {
            mode: 'level', // level, favorites, mistakes
            level: 1,
            score: 0, 
            totalErrorsInLevel: 0, // ç¸½å…±æœ‰å¹¾å€‹éŒ¯å­—è¦æ”¹
            currentQuestionIndex: 0, // ç›®å‰ç¬¬å¹¾é¡Œ (å¥å­)
            fixedErrorsCount: 0, // æœ¬é¡Œå·²ä¿®å¾©çš„éŒ¯èª¤æ•¸
            errorsFixedState: [], // è¨˜éŒ„æœ¬é¡Œå“ªäº›éŒ¯èª¤å·²è¢«ä¿®å¾© (å­˜éŒ¯èª¤çš„ index)
            qIds: [] 
        };

        const audioCorrect = new Audio('sounds/correct.mp3'); audioCorrect.volume = 0.4;
        const audioFail = new Audio('sounds/fail.mp3'); audioFail.volume = 0.4;

        // --- åˆå§‹åŒ– ---
        fetch('questions.json').then(res => res.json())
            .then(data => { allQuestions = data; renderQuickLogin(); })
            .catch(e => console.error("Error loading questions:", e));

        function getUserKey(key) { return APP_PREFIX + userName + '_' + key; }

        // --- ç™»å…¥èˆ‡å°èˆª ---
        function selectAvatar(img, el) {
            currentAvatar = img;
            document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }

        function loginAndStart() {
            const name = document.getElementById('username').value.trim();
            if(!name) return alert('è«‹è¼¸å…¥é›…è™Ÿ');
            userName = name;
            saveUser();
            if(isPlayerReady && !isPlaying) player.playVideo();
            goToDashboard();
        }

        function saveUser() {
            let users = JSON.parse(localStorage.getItem(APP_PREFIX+'savedUsers')) || [];
            if(!users.some(u => u.name === userName)) {
                users.push({name: userName, avatar: currentAvatar});
                localStorage.setItem(APP_PREFIX+'savedUsers', JSON.stringify(users));
            }
        }
        
        function renderQuickLogin() {
            const users = JSON.parse(localStorage.getItem(APP_PREFIX+'savedUsers')) || [];
            const container = document.getElementById('quick-login-area');
            container.innerHTML = users.map(u => `
                <div class="user-tag" onclick="quickLogin('${u.name}', '${u.avatar}')">
                    <img src="images/${u.avatar}" style="width:20px;height:20px;border-radius:50%;">${u.name}
                    <span class="delete-user" onclick="event.stopPropagation();deleteUser('${u.name}')">Ã—</span>
                </div>
            `).join('');
        }

        function quickLogin(name, av) {
            document.getElementById('username').value = name;
            currentAvatar = av;
            loginAndStart();
        }

        function deleteUser(name) {
            if(!confirm(`åˆªé™¤ ${name} çš„æ‰€æœ‰è³‡æ–™ï¼Ÿ`)) return;
            const prefix = APP_PREFIX + name;
            Object.keys(localStorage).forEach(key => {
                if(key.startsWith(prefix)) localStorage.removeItem(key);
            });
            let users = JSON.parse(localStorage.getItem(APP_PREFIX+'savedUsers')) || [];
            localStorage.setItem(APP_PREFIX+'savedUsers', JSON.stringify(users.filter(u => u.name !== name)));
            renderQuickLogin();
        }

        function goToDashboard() {
            const navInfo = document.getElementById('quiz-nav-info');
            if(navInfo) navInfo.style.display = 'none';

            const dashBtns = document.getElementById('dashboard-nav-btns');
            if(dashBtns) dashBtns.style.display = 'flex';

            hideAllScreens();
            document.getElementById('level-screen').style.display = 'block';
            document.getElementById('display-name').innerText = userName;
            document.getElementById('user-avatar-display').src = "images/" + currentAvatar;
            
            renderLevelGrid();
        }

        function hideAllScreens() {
            document.querySelectorAll('.container-box').forEach(el => el.style.display = 'none');
            document.getElementById('score-box').style.display = 'none';
        }

        function showToast(message) {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- å„€è¡¨æ¿èˆ‡é—œå¡é¸æ“‡ ---
        function renderLevelGrid() {
            const grid = document.getElementById('level-grid');
            if(!grid) return console.error("Level grid element not found!");
            
            grid.innerHTML = "";
            let progress;
            try {
                progress = JSON.parse(localStorage.getItem(getUserKey('quizProgress'))) || { maxLevel: 1, scores: {} };
            } catch(e) {
                progress = { maxLevel: 1, scores: {} };
            }
            
            if(!progress.scores) progress.scores = {};
            if(!progress.maxLevel) progress.maxLevel = 1;

            let completedLevels = Object.keys(progress.scores).length;
            let percent = Math.round((completedLevels / LEVEL_CONFIG.length) * 100);
            document.getElementById('overall-progress').innerText = `ç¸½é€²åº¦ï¼š${percent}%`;

            LEVEL_CONFIG.forEach((_, idx) => {
                const level = idx + 1;
                const btn = document.createElement('button');
                btn.className = 'level-grid-btn';
                
                if (level <= progress.maxLevel) {
                    const score = progress.scores[level];
                    let icon = 'ğŸ“'; 
                    if (score !== undefined) {
                        if (score >= 90) icon = 'ğŸ¥‡'; 
                        else if (score >= 70) icon = 'ğŸ¥ˆ';
                        else icon = 'ğŸ¥‰';
                    }
                    
                    const savedKey = getUserKey('progress_level_' + level);
                    const hasSaved = localStorage.getItem(savedKey);
                    const resumeText = hasSaved ? '<div class="resume-text">(æœªå®Œå¾…çºŒ)</div>' : '';

                    btn.innerHTML = `<div class="lvl-icon">${icon}</div><div class="lvl-label">é—œå¡ ${level}</div>${score !== undefined ? `<div class="lvl-score">${score}åˆ†</div>` : ''}${resumeText}`;
                    btn.onclick = () => startQuiz(level);
                } else {
                    btn.disabled = true;
                    btn.innerHTML = `<div class="lvl-icon" style="filter:grayscale(1);">ğŸ”’</div><div class="lvl-label">é—œå¡ ${level}</div>`;
                }
                grid.appendChild(btn);
            });
        }

        // --- æ¸¬é©—é‚è¼¯ (New Error Hunt Logic) ---
        function startQuiz(level) {
            let startIdx = 0;
            for(let i=0; i<level-1; i++) startIdx += LEVEL_CONFIG[i];
            let endIdx = startIdx + LEVEL_CONFIG[level-1];
            
            currentQuizData = allQuestions.slice(startIdx, endIdx);
            
            const saveKey = getUserKey('progress_level_' + level);
            const savedState = localStorage.getItem(saveKey);

            if (savedState) {
                quizState = JSON.parse(savedState);
                quizState.mode = 'level';
                // Recalculate total errors just in case
                let total = 0;
                currentQuizData.forEach(q => total += q.corrections.length);
                quizState.totalErrorsInLevel = total;
            } else {
                quizState = {
                    mode: 'level',
                    level: level,
                    score: 0,
                    totalErrorsInLevel: 0,
                    currentQuestionIndex: 0,
                    fixedErrorsCount: 0,
                    errorsFixedState: [] // indices of fixed chars relative to the sentence string
                };
                currentQuizData.forEach(q => quizState.totalErrorsInLevel += q.corrections.length);
            }
            
            loadQuizUI();
        }

        function startReviewQuiz(mode, qIds) {
            if (!qIds || qIds.length === 0) return alert("ç›®å‰æ²’æœ‰é¡Œç›®ï¼");
            
            currentQuizData = allQuestions.filter(q => qIds.includes(q.id));
            
            quizState = {
                mode: mode,
                level: 0,
                score: 0,
                totalErrorsInLevel: 0,
                currentQuestionIndex: 0,
                fixedErrorsCount: 0,
                errorsFixedState: [],
                qIds: qIds
            };
            
            currentQuizData.forEach(q => quizState.totalErrorsInLevel += q.corrections.length);
            loadQuizUI();
        }

        function saveQuizProgress() {
            if(quizState.mode === 'level') {
                const saveKey = getUserKey('progress_level_' + quizState.level);
                localStorage.setItem(saveKey, JSON.stringify(quizState));
            }
        }

        function loadQuizUI() {
            hideAllScreens();
            
            const dashBtns = document.getElementById('dashboard-nav-btns');
            if(dashBtns) dashBtns.style.display = 'none';

            document.getElementById('quiz-content').style.display = 'block';
            let title = "";
            if (quizState.mode === 'level') title = `ğŸ“ é—œå¡ ${quizState.level}`;
            else if (quizState.mode === 'favorites') title = `â­ æˆ‘çš„æœ€æ„›`;
            else if (quizState.mode === 'mistakes') title = `ğŸ“• éŒ¯é¡Œè¤‡ç¿’`;
            
            document.getElementById('level-title').innerText = title;
            document.getElementById('nav-level-title').innerText = title;

            document.getElementById('quiz-nav-info').style.display = 'flex';
            document.getElementById('nav-total-q').innerText = currentQuizData.length;

            loadQuestion();
        }

        function loadQuestion() {
            const qData = currentQuizData[quizState.currentQuestionIndex];
            if(!qData) return finishQuiz();
            
            // UI Reset
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('options-area').innerHTML = '<div class="options-placeholder">ğŸ‘ˆ è«‹å…ˆåœ¨å·¦å´æ‰¾å‡ºéŒ¯åˆ¥å­—</div>';
            document.getElementById('nav-current-q').innerText = quizState.currentQuestionIndex + 1;
            
            const favIcon = document.getElementById('fav-icon');
            updateFavIcon(qData.id);
            favIcon.onclick = () => toggleFavorite(qData.id);

            // Render Sentence
            renderSentence(qData);
        }

        function renderSentence(qData) {
            const container = document.getElementById('sentence-display');
            container.innerHTML = "";
            
            // Convert sentence string into interactive spans
            const sentence = qData.content;
            
            // We need to rebuild the sentence char by char.
            // If a char index was fixed in saved state, render correct char.
            // Else render original char.
            
            // To handle surrogate pairs or complex chars correctly, simple split might not be enough, 
            // but for standard Traditional Chinese, split('') usually works fine.
            const chars = sentence.split('');
            
            chars.forEach((char, idx) => {
                const span = document.createElement('span');
                span.className = 'interactive-char';
                span.id = `char-${idx}`;
                
                // Check if this index corresponds to an error
                const isError = qData.corrections.find(c => c.index === idx);
                const isFixed = quizState.errorsFixedState.includes(idx);

                if (isFixed && isError) {
                    span.innerText = isError.correct;
                    span.classList.add('fixed');
                } else {
                    span.innerText = char;
                    if(isError) {
                        // Secretly mark it? No, keep it clean. Logic handles it.
                    }
                }

                span.onclick = () => handleCharClick(idx, char, isError, isFixed);
                container.appendChild(span);
            });
            
            // Check completion (in case restored state is fully done)
            checkQuestionCompletion();
        }

        function handleCharClick(idx, char, errorObj, isFixed) {
            if (isFixed) return; // Already fixed
            
            // Remove active class from all others
            document.querySelectorAll('.interactive-char').forEach(el => el.classList.remove('active'));
            document.getElementById(`char-${idx}`).classList.add('active');

            const optionsArea = document.getElementById('options-area');
            
            if (!errorObj) {
                // Clicked a correct character
                showToast("é€™å€‹å­—æ²’æœ‰éŒ¯å–”ï¼ğŸ‘");
                optionsArea.innerHTML = '<div class="options-placeholder">ğŸ‘ˆ é€™å€‹å­—æ˜¯å°çš„ï¼Œè«‹å†æ‰¾æ‰¾ï¼</div>';
                return;
            }

            // Clicked an error -> Show options
            renderOptions(idx, errorObj);
        }

        function renderOptions(charIdx, errorObj) {
            const container = document.getElementById('options-area');
            container.innerHTML = "";
            
            const title = document.createElement('div');
            title.innerHTML = `è«‹é¸æ“‡ <strong>ã€Œ${errorObj.wrong}ã€</strong> çš„æ­£ç¢ºå¯«æ³•ï¼š`;
            title.style.marginBottom = "15px";
            title.style.fontSize = "1.2em";
            container.appendChild(title);

            const btnContainer = document.createElement('div');
            btnContainer.className = 'options-container';

            // Shuffle options logic (if not shuffled in JSON, shuffle here or just trust JSON)
            // The JSON generator should provide shuffled options. 
            // Assuming options are [Correct, Distractor1, Distractor2, Distractor3] mixed.
            
            errorObj.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => handleOptionSelect(charIdx, errorObj, opt, btn);
                btnContainer.appendChild(btn);
            });

            container.appendChild(btnContainer);
        }

        function handleOptionSelect(charIdx, errorObj, selectedOpt, btn) {
            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.disabled = true);

            if (selectedOpt === errorObj.correct) {
                // Correct
                btn.classList.add('correct');
                audioCorrect.play().catch(()=>{});
                confetti({ particleCount: 30, origin: { y: 0.8 }, spread: 50 });
                
                // Update State
                quizState.score++;
                quizState.fixedErrorsCount++;
                quizState.errorsFixedState.push(charIdx);
                saveQuizProgress();

                // Update UI (Sentence)
                const charSpan = document.getElementById(`char-${charIdx}`);
                charSpan.innerText = selectedOpt; // Change to correct char
                charSpan.classList.remove('active');
                charSpan.classList.add('fixed'); // Turn red/fixed style

                // Check if all errors in this sentence are fixed
                checkQuestionCompletion();

            } else {
                // Wrong
                btn.classList.add('wrong');
                audioFail.play().catch(()=>{});
                
                // Add to mistakes
                const qData = currentQuizData[quizState.currentQuestionIndex];
                addToMistakes(qData.id);
                
                // Highlight correct option
                allBtns.forEach(b => {
                    if (b.innerText === errorObj.correct) b.classList.add('correct');
                });
            }
        }

        function checkQuestionCompletion() {
            const qData = currentQuizData[quizState.currentQuestionIndex];
            const totalErrors = qData.corrections.length;
            
            // Count how many fixed in current state
            // Logic: quizState.errorsFixedState contains indices for current question only?
            // Actually, we reset `errorsFixedState` on `nextQuestion`.
            
            if (quizState.errorsFixedState.length >= totalErrors) {
                document.getElementById('next-btn').style.display = 'block';
                document.getElementById('options-area').innerHTML = '<div class="options-placeholder" style="color:var(--correct-color)">ğŸ‰ å¤ªæ£’äº†ï¼æœ¬å¥å·²ä¿®æ­£å®Œç•¢ï¼</div>';
            }
        }

        function nextQuestion() {
            quizState.currentQuestionIndex++;
            quizState.fixedErrorsCount = 0;
            quizState.errorsFixedState = []; 
            
            saveQuizProgress();
            loadQuestion();
            
            document.querySelector('.container-box').scrollIntoView({behavior: 'smooth'});
        }

        function finishQuiz() {
            if(quizState.mode === 'level') {
                localStorage.removeItem(getUserKey('progress_level_' + quizState.level));
            }

            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('quiz-nav-info').style.display = 'none';
            document.getElementById('score-box').style.display = 'block';
            
            // Calculate score based on total found errors
            const finalScore = Math.round((quizState.score / quizState.totalErrorsInLevel) * 100);
            document.getElementById('final-score').innerText = finalScore;
            document.getElementById('final-name').innerText = userName;
            
            if(quizState.mode === 'level') {
                let progress = JSON.parse(localStorage.getItem(getUserKey('quizProgress'))) || { maxLevel: 1, scores: {} };
                
                let oldScore = progress.scores[quizState.level] || 0;
                if(finalScore > oldScore) progress.scores[quizState.level] = finalScore;
                else if (!progress.scores[quizState.level]) progress.scores[quizState.level] = finalScore;
                
                let unlocked = false;
                if(quizState.level === progress.maxLevel && quizState.level < LEVEL_CONFIG.length) {
                    progress.maxLevel++;
                    unlocked = true;
                }
                localStorage.setItem(getUserKey('quizProgress'), JSON.stringify(progress));
                document.getElementById('unlock-msg').style.display = unlocked ? 'block' : 'none';
            } else {
                document.getElementById('unlock-msg').style.display = 'none';
            }
            
            let cmt = "å†æ¥å†å²ï¼";
            if(finalScore == 100) cmt = "ç«çœ¼é‡‘ç›ï¼ŒéŒ¯å­—ç„¡æ‰€éå½¢ï¼";
            else if(finalScore >= 80) cmt = "æ ¡å°é«˜æ‰‹ï¼Œä»¤äººä½©æœï¼";
            else if(finalScore >= 60) cmt = "ç´°å¿ƒè§€å¯Ÿï¼Œç¹¼çºŒä¿æŒï¼";
            document.getElementById('score-comment').innerText = cmt;

            saveHistory(finalScore, quizState.mode === 'level' ? `é—œå¡ ${quizState.level}` : (quizState.mode === 'favorites' ? 'æˆ‘çš„æœ€æ„›' : 'éŒ¯é¡Œè¤‡ç¿’'));
        }

        // --- Utils (Favorites, Mistakes, History, AI) ---
        // (Similar logic to previous version, adjusted for Sentence ID)
        
        function toggleFavorite(qId) {
            let favs = JSON.parse(localStorage.getItem(getUserKey('favorites'))) || [];
            const index = favs.indexOf(qId);
            if (index > -1) favs.splice(index, 1);
            else favs.push(qId);
            localStorage.setItem(getUserKey('favorites'), JSON.stringify(favs));
            updateFavIcon(qId);
        }

        function updateFavIcon(qId) {
            let favs = JSON.parse(localStorage.getItem(getUserKey('favorites'))) || [];
            const icon = document.getElementById('fav-icon');
            if (favs.includes(qId)) { icon.innerHTML = 'â™¥'; icon.classList.add('active'); } 
            else { icon.innerHTML = 'â™¡'; icon.classList.remove('active'); }
        }

        function addToMistakes(qId) {
            let mistakes = JSON.parse(localStorage.getItem(getUserKey('mistakes'))) || [];
            if (!mistakes.includes(qId)) {
                mistakes.push(qId);
                localStorage.setItem(getUserKey('mistakes'), JSON.stringify(mistakes));
            }
        }

        function showFavorites() {
            hideAllScreens();
            document.getElementById('favorites-screen').style.display = 'block';
            const list = document.getElementById('favorites-list');
            list.innerHTML = "";
            let favs = JSON.parse(localStorage.getItem(getUserKey('favorites'))) || [];
            if (favs.length === 0) {
                list.innerHTML = "<div class='list-empty-msg'>ç›®å‰æ²’æœ‰æ”¶è—ä»»ä½•å¥å­å–”ï¼</div>";
                return;
            }
            const favQuestions = allQuestions.filter(q => favs.includes(q.id));
            favQuestions.forEach(q => renderListItem(q, list, 'favorites'));
            if (favQuestions.length > 1) {
                const btnAll = document.createElement('button');
                btnAll.className = "btn";
                btnAll.style.marginTop = "20px";
                btnAll.style.width = "100%";
                btnAll.innerText = "ğŸš€ ç·´ç¿’å…¨éƒ¨æ”¶è—";
                btnAll.onclick = () => startReviewQuiz('favorites', favs);
                list.appendChild(btnAll);
            }
        }

        function showMistakes() {
            hideAllScreens();
            document.getElementById('mistakes-screen').style.display = 'block';
            const list = document.getElementById('mistakes-list');
            list.innerHTML = "";
            let mistakes = JSON.parse(localStorage.getItem(getUserKey('mistakes'))) || [];
            if (mistakes.length === 0) {
                list.innerHTML = "<div class='list-empty-msg'>å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰éŒ¯é¡Œï¼</div>";
                return;
            }
            const mistakeQuestions = allQuestions.filter(q => mistakes.includes(q.id));
            mistakeQuestions.forEach(q => renderListItem(q, list, 'mistakes'));
            if (mistakeQuestions.length > 1) {
                const btnAll = document.createElement('button');
                btnAll.className = "btn btn-red";
                btnAll.style.marginTop = "20px";
                btnAll.style.width = "100%";
                btnAll.innerText = "ğŸš€ è¤‡ç¿’å…¨éƒ¨éŒ¯é¡Œ";
                btnAll.onclick = () => startReviewQuiz('mistakes', mistakes);
                list.appendChild(btnAll);
            }
        }

        function renderListItem(q, container, type) {
            const item = document.createElement('div');
            item.className = `list-item-card ${type === 'favorites' ? 'fav-item' : 'mistake-item'}`;
            // Show snippet of content
            const snippet = q.content.length > 20 ? q.content.substring(0, 20) + '...' : q.content;
            item.innerHTML = `<div class="list-item-title">${snippet}</div><div class="list-item-info">éŒ¯å­—æ•¸: ${q.corrections.length}</div>`;
            item.onclick = () => startReviewQuiz(type, [q.id]);
            container.appendChild(item);
        }

        function saveHistory(score, modeTitle) {
            let history = JSON.parse(localStorage.getItem(getUserKey('quizHistory'))) || [];
            history.push({ date: new Date().toLocaleString(), score: score, mode: modeTitle });
            localStorage.setItem(getUserKey('quizHistory'), JSON.stringify(history));
        }
        
        function showHistory() {
            hideAllScreens();
            document.getElementById('history-screen').style.display = 'block';
            const list = document.getElementById('history-list');
            let history = JSON.parse(localStorage.getItem(getUserKey('quizHistory'))) || [];
            list.innerHTML = history.reverse().map(h => `
                <li style="background:#fff; padding:15px; border-bottom:1px solid #eee; margin-bottom:10px; border-radius:5px;">
                    <strong>${h.mode}</strong> - <span style="color:${h.score>=60?'green':'red'}">${h.score}åˆ†</span>
                    <br><small>${h.date}</small>
                </li>
            `).join('') || '<p style="text-align:center">ç„¡ç´€éŒ„</p>';
        }

        function logout() { location.reload(); }
        function exitQuiz() { goToDashboard(); }

        // --- AI Chat ---
        function toggleChatWindow() {
            const win = document.getElementById('ai-chat-window');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        }
        function handleAiKeypress(e) { if (e.key === 'Enter') sendAiMessage(); }
        function resetAiKey() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤ç›®å‰å„²å­˜çš„ API Key å—ï¼Ÿ")) {
                localStorage.removeItem(APP_PREFIX + 'gemini_api_key');
                alert("API Key å·²æ¸…é™¤ï¼");
            }
        }
        async function sendAiMessage() {
            const input = document.getElementById('ai-input');
            const msgArea = document.getElementById('ai-messages');
            const userText = input.value.trim();
            if (!userText) return;
            let apiKey = localStorage.getItem(APP_PREFIX + 'gemini_api_key');
            if (!apiKey) {
                const inputKey = prompt("è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Keyï¼š");
                if (!inputKey || inputKey.trim() === "") { alert("éœ€è¦ API Key æ‰èƒ½ä½¿ç”¨å–”ï¼"); return; }
                apiKey = inputKey.trim();
                localStorage.setItem(APP_PREFIX + 'gemini_api_key', apiKey);
            }
            const userMsg = document.createElement('div');
            userMsg.className = 'ai-msg user';
            userMsg.innerText = userText;
            msgArea.appendChild(userMsg);
            input.value = '';
            msgArea.scrollTop = msgArea.scrollHeight;
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'ai-msg bot';
            loadingMsg.innerText = 'è¼¸å…¥ä¸­...';
            loadingMsg.id = 'ai-loading';
            msgArea.appendChild(loadingMsg);
            msgArea.scrollTop = msgArea.scrollHeight;
            try {
                const response = await fetch(GEMINI_API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userText }] }],
                        systemInstruction: { parts: [{ text: "ä½ æ˜¯ä¸€å€‹åœ‹æ–‡æ”¹éŒ¯å­—å°ˆå®¶ã€‚é‡å°ä½¿ç”¨è€…çš„å•é¡Œï¼Œè«‹è§£é‡‹è©²å­—çš„æ­£ç¢ºå¯«æ³•èˆ‡éŒ¯èª¤åŸå› ï¼Œå›ç­”ç°¡æ˜æ‰¼è¦ã€‚" }] }
                    })
                });
                const data = await response.json();
                document.getElementById('ai-loading').remove();
                if (data.error) throw new Error(data.error.message);
                const botText = data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›ç­”ã€‚";
                const botMsg = document.createElement('div');
                botMsg.className = 'ai-msg bot';
                botMsg.innerText = botText;
                msgArea.appendChild(botMsg);
            } catch (error) {
                console.error(error);
                if(document.getElementById('ai-loading')) document.getElementById('ai-loading').remove();
                const errorMsg = document.createElement('div');
                errorMsg.className = 'ai-msg bot';
                errorMsg.style.color = 'red';
                errorMsg.innerText = `é€£ç·šéŒ¯èª¤: ${error.message}`;
                msgArea.appendChild(errorMsg);
                if (error.message.includes('400') || error.message.includes('key')) {
                    if(confirm("é€£ç·šå¤±æ•—ï¼Œå¯èƒ½æ˜¯ API Key ç„¡æ•ˆã€‚æ˜¯å¦æ¸…é™¤ï¼Ÿ")) localStorage.removeItem(APP_PREFIX + 'gemini_api_key');
                }
            }
            msgArea.scrollTop = msgArea.scrollHeight;
        }

        // --- YouTube ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('yt-player', {
                height: '100%', width: '100%',
                videoId: YOUTUBE_PLAYLIST[currentVideoIdx],
                playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 1, 'fs': 0, 'rel': 0 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }
        function onPlayerReady() { isPlayerReady = true; player.setVolume(30); }
        function onPlayerStateChange(e) { 
            isPlaying = (e.data == YT.PlayerState.PLAYING);
            document.getElementById('main-play-btn').innerText = isPlaying ? 'â¸' : 'â–¶';
            if(e.data == YT.PlayerState.ENDED) playRandomTrack();
        }
        function togglePlay() { if(isPlayerReady) isPlaying ? player.pauseVideo() : player.playVideo(); }
        function prevTrack() { if(isPlayerReady) { currentVideoIdx = (currentVideoIdx - 1 + YOUTUBE_PLAYLIST.length) % YOUTUBE_PLAYLIST.length; player.loadVideoById(YOUTUBE_PLAYLIST[currentVideoIdx]); } }
        function nextTrack() { if(isPlayerReady) { currentVideoIdx = (currentVideoIdx + 1) % YOUTUBE_PLAYLIST.length; player.loadVideoById(YOUTUBE_PLAYLIST[currentVideoIdx]); } } 
        function playRandomTrack() {
             if(isPlayerReady) {
                let newIdx;
                do { newIdx = Math.floor(Math.random() * YOUTUBE_PLAYLIST.length); } while (newIdx === currentVideoIdx && YOUTUBE_PLAYLIST.length > 1);
                currentVideoIdx = newIdx;
                player.loadVideoById(YOUTUBE_PLAYLIST[currentVideoIdx]);
            }
        }
        function setVolume(v) { if(isPlayerReady) player.setVolume(v); }
        function toggleVideoDisplay() {
            const wrap = document.getElementById('yt-wrapper');
            const btn = document.getElementById('toggle-video-btn');
            if(window.innerWidth <= 768) wrap.classList.toggle('mobile-visible');
            else wrap.classList.toggle('video-hidden');
            const hidden = wrap.classList.contains('video-hidden') && !wrap.classList.contains('mobile-visible');
            btn.classList.toggle('active', !hidden);
        }
        function changeMode() {} 

    </script>
</body>
</html>